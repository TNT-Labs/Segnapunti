<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Segnapunti - Partita</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4A148C">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
  
  <link rel="apple-touch-icon" href="icon-192.png"> 
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"> 
  
  <link rel="stylesheet" href="segnapunti.css">
</head>
<body>
  <div class="container">
    <div class="header-controls fixed-header"> 
      <h1>ğŸƒ Punteggi Attuali</h1>
      <div class="top-buttons">
          <button id="toggle-dark-mode" title="Attiva/Disattiva ModalitÃ  Scura" aria-label="Attiva modalitÃ  scura" onclick="toggleDarkMode()">ğŸŒ™</button>
      </div>
    </div>
    
    <div class="winner-message" id="winner-message" style="display: none;">
    </div>
    
    <div class="game-over-actions" id="game-over-actions" style="display: none;">
      <button id="btn-ricomincia-partita" class="btn-primary">ğŸ”„ Ricomincia Partita</button>
    </div>
    
    <ul class="giocatori-lista" id="giocatori-lista-partita" role="list" aria-label="Lista giocatori">
    </ul>
    
    <hr class="separator">

    <div id="modal-overlay" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="modal-title-player-name">
      <div class="modal-content">
          <h2 id="modal-title-player-name">Aggiungi Punti</h2>
          <form id="modal-input-form">
              <input type="number" id="punteggio-input-custom" placeholder="Inserisci punti (es. 20 o -5)" required inputmode="numeric" aria-label="Inserisci punteggio personalizzato">
              
              <div class="quick-score-buttons">
                  <button type="button" id="btn-quick-plus10" class="btn-primary" aria-label="Aggiungi 10 punti">+10</button>
                  <button type="button" id="btn-quick-minus10" class="btn-rimuovi" aria-label="Rimuovi 10 punti">-10</button>
                  <button type="button" id="btn-quick-plus20" class="btn-primary" aria-label="Aggiungi 20 punti">+20</button>
                  <button type="button" id="btn-quick-minus20" class="btn-rimuovi" aria-label="Rimuovi 20 punti">-20</button>
                  <button type="button" id="btn-quick-plus50" class="btn-primary" aria-label="Aggiungi 50 punti">+50</button>
                  <button type="button" id="btn-quick-minus50" class="btn-rimuovi" aria-label="Rimuovi 50 punti">-50</button>
              </div>

              <div class="modal-action-buttons">
                  <button type="button" id="btn-modal-annulla" class="btn-reset">Annulla</button>
                  <button type="submit" id="btn-modal-applica" class="btn-primary">Applica Punti</button>
              </div>
          </form>
      </div>
  </div>
  
  <div id="loader-overlay" class="loader-overlay" style="display: flex;" role="status" aria-live="polite">
      <div class="loader-spinner" aria-hidden="true"></div>
      <p id="loader-text">Caricamento dati...</p>
  </div>
  
  <!-- Bottom Navigation Bar -->
  <nav class="bottom-nav" role="navigation" aria-label="Navigazione principale">
    <a href="index.html" class="nav-item active" aria-label="Partita" aria-current="page">
      <span class="nav-icon" aria-hidden="true">ğŸƒ</span>
      <span class="nav-label">Partita</span>
    </a>
    <a href="storico.html" class="nav-item" aria-label="Storico">
      <span class="nav-icon" aria-hidden="true">ğŸ“œ</span>
      <span class="nav-label">Storico</span>
    </a>
    <a href="settings.html" class="nav-item" aria-label="Impostazioni">
      <span class="nav-icon" aria-hidden="true">âš™ï¸</span>
      <span class="nav-label">Settings</span>
    </a>
    <a href="preset-manager.html" class="nav-item" aria-label="Gestione preset">
      <span class="nav-icon" aria-hidden="true">ğŸ®</span>
      <span class="nav-label">Preset</span>
    </a>
    <a href="premium.html" class="nav-item" aria-label="Premium">
      <span class="nav-icon" aria-hidden="true">âœ¨</span>
      <span class="nav-label">Premium</span>
    </a>
  </nav>

  <!-- âœ… FIX #2: Storage Helper PRIMA di tutto -->
  <script src="storage-helper.js"></script>
  <script src="segnapunti.js"></script>
  <script src="preset-manager.js"></script>
  
  <!-- âœ… MONETIZATION SYSTEM -->
  <script src="billing-module.js"></script>
  <script src="ads-module.js"></script>
  <script src="premium-ui.js"></script>
  
  <script>
    // âœ… Global error handler per unhandled promise rejections
    window.addEventListener('unhandledrejection', (event) => {
      console.error('âŒ Unhandled promise rejection:', event.reason);
      event.preventDefault();
      
      const message = event.reason?.message || 'Si Ã¨ verificato un errore';
      
      // Non spammare l'utente con errori
      if (!window._lastErrorTime || Date.now() - window._lastErrorTime > 5000) {
        alert(`âš ï¸ ${message}\n\nRicarica la pagina se il problema persiste.`);
        window._lastErrorTime = Date.now();
      }
    });

    // âœ… Service Worker con gestione aggiornamenti
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('âœ… Service Worker registrato:', registration.scope);
                    
                    // Controlla aggiornamenti
                    registration.addEventListener('updatefound', () => {
                      console.log('ğŸ”„ Nuovo Service Worker trovato');
                    });
                })
                .catch(error => {
                    console.error('âŒ Registrazione Service Worker fallita:', error);
                });
        });
        
        // Notifica quando il SW cambia (nuova versione disponibile)
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('ğŸ‰ Nuova versione disponibile');
          
          // Mostra banner di aggiornamento
          const banner = document.createElement('div');
          banner.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            text-align: center;
            z-index: 10002;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
          `;
          banner.innerHTML = `
            <strong>ğŸ‰ Nuova versione disponibile!</strong>
            <button onclick="location.reload()" style="
              margin-left: 15px;
              background: white;
              color: #4CAF50;
              border: none;
              padding: 6px 16px;
              border-radius: 4px;
              font-weight: 600;
              cursor: pointer;
              font-size: 0.9em;
            ">Ricarica ora</button>
          `;
          document.body.prepend(banner);
        });
    }
    
    // âœ… FIX #1: Loader error handling con finally
    document.addEventListener('DOMContentLoaded', async () => {
      const loader = document.getElementById('loader-overlay');
      const loaderText = document.getElementById('loader-text');
      
      try {
        // Mostra warning se storage non disponibile (Safari private mode)
        if (typeof StorageHelper !== 'undefined') {
          StorageHelper.showWarningIfUnavailable();
        }
        
        // 1. Init billing PRIMA
        if (typeof BillingModule !== 'undefined') {
          await BillingModule.init();
          console.log('âœ… BillingModule inizializzato');
        }
        
        // 2. Init ads solo se non premium
        if (typeof BillingModule !== 'undefined' && typeof AdsModule !== 'undefined') {
          if (!BillingModule.isPremium()) {
            await AdsModule.init();
            console.log('âœ… AdsModule inizializzato');
          } else {
            console.log('â­ï¸ AdsModule skipped (utente premium)');
          }
        }
        
        // 3. Init Premium UI DOPO billing
        if (typeof PremiumUIModule !== 'undefined') {
          await PremiumUIModule.init();
          console.log('âœ… PremiumUIModule inizializzato');
        }
        
      } catch (error) {
        console.error('âŒ Monetization init error:', error);
        
        // Mostra messaggio errore user-friendly
        if (loaderText) {
          loaderText.textContent = 'âš ï¸ Errore caricamento. Ricarica la pagina.';
          loaderText.style.color = '#ff6b6b';
        }
        
        // Continua comunque con l'app (modalitÃ  degradata)
        console.warn('âš ï¸ App in modalitÃ  degradata senza monetization');
        
      } finally {
        // âœ… CRITICAL: Nascondi loader SEMPRE
        if (loader) {
          setTimeout(() => {
            loader.style.display = 'none';
            console.log('âœ… Loader nascosto');
          }, 500);
        }
      }
    });
  </script>
</body>
</html>
