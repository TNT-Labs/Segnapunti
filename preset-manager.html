<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Segnapunti - Gestione Preset</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4A148C">
  <!-- âœ… FIX BUG #44: Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self';">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
  
  <link rel="apple-touch-icon" href="icon-192.png"> 
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"> 
  
  <style>
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loader-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #4b86b4;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loader-overlay p {
      color: white;
      margin-top: 20px;
    }
  </style>
  <link rel="stylesheet" href="segnapunti.css">
  <link rel="stylesheet" href="preset-manager.css">
  <link rel="stylesheet" href="segnapunti-mobile.css">
  <link rel="stylesheet" href="utility-classes.css">
</head>
<body>
  <div class="container">
    <div class="header-controls fixed-header">
      <h1>ğŸ® Gestione Preset</h1>
      <div class="top-buttons">
          <!-- âœ… FIX BUG #19: Aggiunto aria-label per accessibilitÃ  -->
          <button id="toggle-dark-mode" title="Attiva/Disattiva ModalitÃ  Scura" aria-label="Attiva o disattiva modalitÃ  scura" onclick="toggleDarkMode()">ğŸŒ™</button>
      </div>
    </div>
    
    <!-- Toolbar -->
    <div class="preset-toolbar">
      <button id="btn-create-preset" class="btn-primary">
        â• Nuovo Preset
      </button>
      
      <div class="preset-toolbar-actions">
        <button id="btn-import-presets" class="btn-secondary" title="Importa preset da file JSON">
          ğŸ“¥ Importa
        </button>
        <button id="btn-export-presets" class="btn-secondary" title="Esporta preset personalizzati">
          ğŸ“¤ Esporta
        </button>
        <button id="btn-restore-defaults" class="btn-reset" title="Elimina tutti i preset personalizzati">
          ğŸ”„ Ripristina Default
        </button>
      </div>
    </div>

    <!-- Info Box -->
    <div class="info-box">
      <p><strong>ğŸ’¡ Come funziona:</strong></p>
      <ul>
        <li>âœ… <strong>17 preset predefiniti</strong> pronti all'uso (Scala 40, Briscola, Tennis, ecc.)</li>
        <li id="free-limit-info" style="display:none;">ğŸ <strong>1 preset personalizzato gratis</strong> - Sblocca illimitati con Premium!</li>
        <li>âœï¸ <strong>Modifica</strong> i tuoi preset personalizzati</li>
        <li>ğŸ“‹ <strong>Duplica</strong> qualsiasi preset per usarlo come base</li>
        <li>ğŸ† <strong>ModalitÃ  Rounds</strong>: Imposta punteggio limite + chi vince (max/min) per determinare la fine di ogni round, poi scegli quanti round servono per vincere la partita</li>
        <li>ğŸ’¾ <strong>Esporta/Importa</strong> i tuoi preset per condividerli o fare backup</li>
      </ul>
    </div>

    <!-- Lista Preset -->
    <div id="preset-list-container" class="preset-list-container">
      <!-- Popolato dinamicamente da JavaScript -->
    </div>

  </div>

  <!-- Modal Crea/Modifica Preset -->
  <div id="preset-edit-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-large">
      <h2 id="preset-modal-title">â• Nuovo Preset</h2>
      
      <form id="preset-form" onsubmit="return false;">
        <div class="form-row">
          <!-- âœ… NASCOSTO v1.3.3: Il codice viene auto-generato dal nome -->
          <div class="form-group" style="display:none;">
            <label for="preset-key">Codice Preset</label>
            <input 
              type="text" 
              id="preset-key" 
              placeholder="es: mio_gioco" 
              pattern="[a-z0-9_]+"
              title="Solo lettere minuscole, numeri e underscore">
              <!-- âœ… RIMOSSO required - non piÃ¹ necessario -->
            <small>Auto-generato dal nome del gioco</small>
          </div>

          <div class="form-group">
            <label for="preset-name">Nome Gioco *</label>
            <input 
              type="text" 
              id="preset-name" 
              placeholder="es: Mio Gioco Preferito" 
              maxlength="50"
              required>
            <small>Il codice verrÃ  generato automaticamente da questo nome</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="preset-mode">ModalitÃ  Vittoria *</label>
            <select id="preset-mode" required>
              <option value="max">ğŸ“ˆ Vince chi fa PIÃ™ punti</option>
              <option value="min">ğŸ“‰ Vince chi fa MENO punti</option>
              <option value="rounds">ğŸ† Vince chi vince piÃ¹ ROUNDS</option>
              <option value="darts">ğŸ¯ Freccette (da punteggio a 0)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="preset-target">Punteggio Obiettivo *</label>
            <input 
              type="number" 
              id="preset-target" 
              min="0" 
              max="999999"
              placeholder="es: 100" 
              required>
          </div>
        </div>

        <!-- ğŸ†• NUOVO: Campi Rounds -->
        <div id="preset-round-mode-field" style="display: none;">
          <div class="form-group">
            <label for="preset-round-mode">ğŸ“Š Come si Vince un Round *</label>
            <select id="preset-round-mode">
              <option value="max">ğŸ“ˆ Vince chi fa PIÃ™ punti</option>
              <option value="min">ğŸ“‰ Vince chi fa MENO punti</option>
            </select>
            <small>Determina quando finisce un singolo round e chi lo vince</small>
          </div>
        </div>
        
        <div id="preset-rounds-field" style="display: none;">
          <div class="form-group">
            <label for="preset-rounds-target">ğŸ† Rounds da Vincere *</label>
            <input 
              type="number" 
              id="preset-rounds-target" 
              min="1" 
              max="99"
              placeholder="es: 3" 
              value="3">
            <small>Numero di rounds/set/mani necessari per vincere la partita</small>
          </div>
        </div>

        <div class="form-group">
          <label for="preset-category">Categoria</label>
          <select id="preset-category">
            <option value="custom">â­ Personalizzato</option>
            <option value="carte">ğŸƒ Giochi di Carte</option>
            <option value="tavolo">ğŸ² Giochi da Tavolo</option>
            <option value="sport">âš½ Sport</option>
            <option value="altri">ğŸ¯ Altri</option>
          </select>
        </div>

        <div class="form-group">
          <label for="preset-description">Descrizione</label>
          <textarea 
            id="preset-description" 
            rows="3" 
            maxlength="200"
            placeholder="Breve descrizione del gioco e delle sue regole..."></textarea>
          <small>Massimo 200 caratteri</small>
        </div>

        <div class="modal-action-buttons">
          <button type="button" id="btn-close-preset-modal" class="btn-reset">
            Annulla
          </button>
          <button type="button" id="btn-save-preset" class="btn-primary">
            ğŸ’¾ Salva Preset
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="loader-overlay" class="loader-overlay" style="display: flex;">
      <div class="loader-spinner"></div>
      <p>Caricamento preset...</p>
  </div>

  <!-- Bottom Navigation Bar -->
  <!-- âœ… FIX BUG #19: Aggiunto aria-current e aria-label per accessibilitÃ  -->
  <nav class="bottom-nav" role="navigation" aria-label="Navigazione principale">
    <a href="index.html" class="nav-item" aria-label="Partita">
      <span class="nav-icon" aria-hidden="true">ğŸƒ</span>
      <span class="nav-label">Partita</span>
    </a>
    <a href="storico.html" class="nav-item" aria-label="Storico partite">
      <span class="nav-icon" aria-hidden="true">ğŸ“œ</span>
      <span class="nav-label">Storico</span>
    </a>
    <a href="settings.html" class="nav-item" aria-label="Impostazioni">
      <span class="nav-icon" aria-hidden="true">âš™ï¸</span>
      <span class="nav-label">Settings</span>
    </a>
    <a href="preset-manager.html" class="nav-item active" aria-current="page" aria-label="Gestione preset (pagina corrente)">
      <span class="nav-icon" aria-hidden="true">ğŸ®</span>
      <span class="nav-label">Preset</span>
    </a>
    <a href="premium.html" class="nav-item" aria-label="Premium">
      <span class="nav-icon" aria-hidden="true">âœ¨</span>
      <span class="nav-label">Premium</span>
    </a>
  </nav>

  <!-- Scripts -->
  <!-- Storage Helper (Safari private mode support) -->
  <!-- âœ… FIX BUG #41: Production-safe logging -->
  <!-- âœ… FIX BUG #43: Polyfills for older browsers -->
  <script src="polyfills.js"></script>

  <script src="logger.js"></script>
  <script src="error-handler.js"></script>

  <script src="storage-helper.js"></script>
  <script src="preset-manager.js"></script>
  
  <!-- âœ… MONETIZATION SYSTEM -->
  <script src="billing-module.js"></script>
  <script src="ads-module.js"></script>
  <script src="premium-ui.js"></script>
  
  <script>
    // âœ… FIX #3 & #8: Inizializzazione with improved error handling
    document.addEventListener('DOMContentLoaded', async () => {
      const loader = document.getElementById('loader-overlay');
      let hasError = false;
      
      if (loader) loader.style.display = 'flex';

      // Update dark mode icon
      const darkMode = localStorage.getItem('darkMode') === 'true';
      if (darkMode) {
        document.body.classList.add('dark-mode');
      }
      const iconBtn = document.getElementById('toggle-dark-mode');
      if (iconBtn) {
        iconBtn.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
      }

      // âœ… FIX #3 & #8: Initialize Monetization with proper error handling
      try {
        // 1. Init billing PRIMA
        await BillingModule.init();
        
        // âœ… CHECK: Mostra info limite free
        if (!BillingModule.isPremium()) {
          const freeLimitInfo = document.getElementById('free-limit-info');
          if (freeLimitInfo) {
            freeLimitInfo.style.display = 'list-item';
            freeLimitInfo.style.background = 'rgba(255, 215, 0, 0.1)';
            freeLimitInfo.style.padding = '5px 10px';
            freeLimitInfo.style.borderRadius = '4px';
            freeLimitInfo.style.marginTop = '5px';
          }
        }
        
        // 2. Init ads solo se non premium
        if (!BillingModule.isPremium()) {
          await AdsModule.init();
        }
        
        // 3. Init Premium UI
        await PremiumUIModule.init();
        
      } catch (error) {
        Logger.error('Monetization init error:', error);
        hasError = true;
        
        // âœ… FIX #8: Mostra messaggio errore user-friendly
        if (loader) {
          const loaderText = loader.querySelector('p');
          if (loaderText) {
            loaderText.textContent = 'âš ï¸ Errore caricamento. Ricarica la pagina.';
            loaderText.style.color = '#ff6b6b';
          }
        }
        
      } finally {
        // âœ… FIX #12: Render preset list con error handling
        try {
          if (window.PresetUI) {
            PresetUI.renderPresetList();
            PresetUI.setupEventListeners();
          } else {
            Logger.error('PresetUI not loaded!');
            hasError = true;
          }
        } catch (renderError) {
          Logger.error('Error rendering presets:', renderError);
          hasError = true;
        }

        // âœ… FIX #8: Nascondi loader SEMPRE, con delay maggiore se c'Ã¨ errore
        if (loader) {
          const delay = hasError ? 2000 : 300;
          setTimeout(() => {
            // âœ… Verifica che l'elemento esista ancora prima di nasconderlo
            if (loader && loader.parentNode) {
              loader.style.display = 'none';
            }
          }, delay);
        }
      }
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    Logger.log('Service Worker registrato con successo:', registration.scope);
                })
                .catch(error => {
                    Logger.error('Registrazione Service Worker fallita:', error);
                });
        });
    }

    // Dark mode toggle
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      
      const iconBtn = document.getElementById('toggle-dark-mode');
      if (iconBtn) {
        iconBtn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
      }
    }
  </script>
</body>
</html>
